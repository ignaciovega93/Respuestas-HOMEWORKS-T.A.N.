-- Respuesta pregunta 1 Clase 7 Parte 2
with ols_porcentajes as (
	select
		count(case when descuento is not null then 1 end) as filled_discount,
		count(case when descuento is null then 2 end) as null_discount,
		count(case when descuento is null then 1 else 1 end) as total_of_discounts,
		count(case when creditos is not null then 1 end) as filled_credits,
		count(case when creditos is null then 2 end) as null_credits,
		count(case when creditos is null then 1 else 1 end) as total_of_credits
	from stg.order_line_sale
)
select
	round(sum((null_discount*100.0)/total_of_discounts), 2) as null_discount_percentage,
	round(sum((null_credits*100.0)/total_of_credits), 2) as null_credits_percentage
from ols_porcentajes
;

-- Respuesta pregunta 2 Clase 7 Parte 2
with revenues_usd as (
	select 
		ols.line_key,
		ols.orden,
		ols.producto,
		ols.tienda,
		ols.fecha,
		ols.cantidad,
		round(case 
			when ols.moneda = 'ARS' 
			then ols.venta/fx.cotizacion_usd_peso
			when ols.moneda = 'URU' 
			then ols.venta/fx.cotizacion_usd_uru
			when ols.moneda = 'EUR' 
			then ols.venta/fx.cotizacion_usd_eur
		end, 4) as ventas_usd,
		round(case 
			when ols.moneda = 'ARS' 
			then coalesce(ols.descuento, 0)/fx.cotizacion_usd_peso
			when ols.moneda = 'URU'   
			then coalesce(ols.descuento, 0)/fx.cotizacion_usd_uru
			when ols.moneda = 'EUR' 
			then coalesce(ols.descuento, 0)/fx.cotizacion_usd_eur
		end, 4) as descuentos_usd,
		round(case 
			when ols.moneda = 'ARS' 
			then ols.impuestos/fx.cotizacion_usd_peso
			when ols.moneda = 'URU' 
			then ols.impuestos/fx.cotizacion_usd_uru
			when ols.moneda = 'EUR' 
			then ols.impuestos/fx.cotizacion_usd_eur
		end, 4) as impuestos_usd,
		ols.moneda,
		ols.pos,
		ols.is_walkout
	from 
		stg.order_line_sale ols
	left join 
		stg.monthly_average_fx_rate fx 
	on 
		fx.mes = date(date_trunc('month', ols.fecha))	
)
select 
	tienda,
	count(case when is_walkout = true then 1 else null end) as walkout_orders,
	sum(case when is_walkout = true then ventas_usd else null end) as usd_walkout_sales,
	round((sum(case when is_walkout = true then ventas_usd else null end)/sum(ventas_usd))*100, 2) as walkout_percentage_over_sales
from revenues_usd
group by 1
;

-- Respuesta pregunta 3 Clase 7 Parte 2

-- Respuesta pregunta 4 Clase 7 Parte 2

-- Respuesta pregunta 5 Clase 7 Parte 2

-- Respuesta pregunta 6 Clase 7 Parte 2
